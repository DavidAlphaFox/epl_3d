function Graph(t){this.options=t||{},this.nodeSet={},this.nodes=[],this.edgeSet={},this.edges=[],this.layout}function Node(t){this.id=t,this.nodesTo=[],this.nodesFrom=[],this.position={},this.data={}}function Edge(t,e){this.source=t,this.target=e,this.data={}}!function(){var t,e,o,i,s,a,n;o=45,e=1,t=1e5,i={initialize:function(i,s){var a,n,r,h,l=this;return null==s&&(s={}),this._renderer=new THREE.WebGLRenderer,this._scene=new THREE.Scene,r=new THREE.DirectionalLight(16777215),r.position.set(1,1,1),this._scene.add(r),r=new THREE.AmbientLight(6710886),this._scene.add(r),this._scene.fog=new THREE.FogExp2(4403,5e-5),this._renderer.setClearColor(this._scene.fog.color,1),this._container=$("#"+i),this._renderer.setSize(this._container.width(),this._container.height()),a=this._container.width()/this._container.height(),this._effectAnaglyph=new THREE.AnaglyphEffect(this._renderer),this._effectAnaglyph.setSize(this._container.width(),this._container.height()),this._effectGrayAnaglyph=new THREE.GrayAnaglyphEffect(this._renderer),this._effectGrayAnaglyph.setSize(this._container.width(),this._container.height()),this._effect=0,this._camera=new THREE.PerspectiveCamera(o,a,e,t),this._camera.position.z=2e3,this._projector=new THREE.Projector,this._controls=new THREE.TrackballControls(this._camera,this._renderer.domElement),this._controls.rotateSpeed=2,this._controls.zoomSpeed=1.2,this._controls.panSpeed=.8,this._controls.noZoom=!1,this._controls.noPan=!1,this._controls.staticMoving=!0,this._controls.dynamicDampingFactor=.3,this._controls.keys=[65,83,68],this._controls.addEventListener("change",function(){return VE._render()}),this._controls.addEventListener("click",function(t){return VE._click(t)}),this._container.append(this._renderer.domElement),this._graph=new Graph,null==(h=s.transparency)&&(s.transparency=!0),this._options=s,n={layout:"3d",attraction:100,repulsion:10,iterations:750,positionUpdated:function(t){var e,o,i,s,a,n,r,h,c,d,u,p,_;for(a=new THREE.Vector3(t.position.x,t.position.y,t.position.z),null!=(u=t.mesh)&&(u.position=a),p=t.nodesTo,_=[],c=0,d=p.length;d>c;c++)s=p[c],null!=(i=l._graph.getEdge(t.id,s.id))&&null!=i.mesh?(n=new THREE.Vector3(s.position.x,s.position.y,s.position.z),e=(new THREE.Vector3).addVectors(a,n).multiplyScalar(.5),o=(new THREE.Vector3).subVectors(n,a),h=(new THREE.Vector3).crossVectors(n,a),r=o.length(),i.mesh.scale=new THREE.Vector3(1,1,r),i.mesh.position=e,_.push(i.mesh.lookAt(n))):_.push(void 0);return _}},this._layout=new Layout.ForceDirected(this._graph,n),this._layout.init(),this._animate()},_click:function(t){var e,o,i,s,a,n;return o=t.pageX-this._container.offset().left,i=t.pageY-this._container.offset().top,console.debug("VE._click: mouse("+o+", "+i+"), camera("+this._camera.position.x+", "+this._camera.position.y+", "+this._camera.position.z+")"),n=new THREE.Vector3(2*(o/this._container.width())-1,2*-(i/this._container.height())+1,.5),this._projector.unprojectVector(n,this._camera),a=new THREE.Raycaster(this._camera.position,n.sub(this._camera.position).normalize()),s=this.mapNodes(function(t){return t.mesh.children[0]}),e=a.intersectObjects(s,!1),e.length>0&&(console.debug("VE._click: Intersect returned '"+e[0].object.userData+"' node ("+e.length+")"),"function"==typeof this.onNodeSelect&&this.onNodeSelect(e[0].object.userData)),this._render()},_render:function(){return 1===this._effect?this._effectAnaglyph.render(this._scene,this._camera):2===this._effect?this._effectGrayAnaglyph.render(this._scene,this._camera):this._renderer.render(this._scene,this._camera)},changeEffect:function(){return this._effect+=1,this._effect%=3,console.debug("VE.changeEffect: Switched to "+this._effect),this._render()},_animate:function(){return this._controls.update(),this._layout.generate(),this._render(),requestAnimationFrame(function(){return VE._animate()})},_nodeGeometry:new THREE.SphereGeometry(s=10,n=16,a=16),_nodeGeometry2:new THREE.SphereGeometry(s=8,n=8,a=8),_edgeMaterial:new THREE.MeshPhongMaterial({color:8947848,ambient:8947848}),setNode:function(t,e){var o,i,s,a,n,r,h,l,c;return o=this._graph.getNode(t),null==o?(console.debug("VE.setNode: creating new node '"+t+"'. Total: "+this._graph.nodes.length),o=new Node(t),i=new THREE.Mesh(this._nodeGeometry,null),i.userData=t,s=new THREE.Mesh(this._nodeGeometry2,this._edgeMaterial),s.add(i),this._scene.add(s),o.mesh=s,o.position=0===this._nodeCounter?{x:0,y:0,z:0}:{x:20*Math.random()-10,y:20*Math.random()-10,z:20*Math.random()-10},this._graph.addNode(o),o.data=e,null==(h=(a=o.data).size)&&(a.size=1),null==(l=(n=o.data).color)&&(n.color=30719),null==(c=(r=o.data).opacity)&&(r.opacity=.7)):(console.debug("VE.setNode: updating node '"+t+"'. Total: "+this._graph.edges.length),o.data.size=e.size,null!=e.color&&(o.data.color=e.color),null!=e.opacity&&(o.data.opacity=e.opacity),o.mesh.children[0].material.dispose()),o.mesh.children[0].scale=new THREE.Vector3(o.data.size,o.data.size,o.data.size),o.mesh.children[0].material=new THREE.MeshPhongMaterial({color:o.data.color,ambient:o.data.color,opacity:o.data.opacity,transparent:this._options.transparency&&o.data.opacity<1}),this._layout.init()},setEdge:function(t,e,o){var i,s,a,n,r,h,l,c,d,u,p,_,y,f,m,g,E;return i=this._graph.getEdge(t,e),null==i?(console.debug("VE.setEdge: creating new edge '"+t+"->"+e+"'"),i=new Edge(this._graph.getNode(t),this._graph.getNode(e)),i.data=o,null==(f=(u=i.data).sizeS)&&(u.sizeS=.8),null==(m=(p=i.data).sizeT)&&(p.sizeT=.05),null==(g=(_=i.data).color)&&(_.color=8947848),null==(E=(y=i.data).opacity)&&(y.opacity=1),this._graph.addEdge(i)):(console.debug("VE.setEdge: updating edge '"+t+"->"+e+"'"),null!=o.sizeS&&(i.data.sizeS=o.sizeS),null!=o.sizeT&&(i.data.sizeT=o.sizeT),null!=o.color&&(i.data.color=o.color),null!=o.opacity&&(i.data.opacity=opacity),this._scene.remove(i.mesh),i.mesh.geometry.dispose(),i.mesh.material.dispose()),s=new THREE.CylinderGeometry(d=10*i.data.sizeT,l=10*i.data.sizeS,a=1,c=8,n=1,h=!1),s.applyMatrix((new THREE.Matrix4).makeRotationX(.5*Math.PI)),r=new THREE.MeshPhongMaterial({color:i.data.color,ambient:i.data.color,opacity:i.data.opacity,transparent:this._options.transparency&&i.data.opacity<1}),i.mesh=new THREE.Mesh(s,r),this._scene.add(i.mesh),this._layout.init()},focusNode:function(t){var e;return e=this._graph.getNode(t),null!=e?this._controls.target=new THREE.Vector3(e.position.x,e.position.y,e.position.z):void 0},mapNodes:function(t){var e,o,i,s,a;for(s=this._graph.nodes,a=[],o=0,i=s.length;i>o;o++)e=s[o],a.push(t(e));return a}},window.VE=i}.call(this),Graph.prototype.addNode=function(t){return void 0!=this.nodeSet[t.id]||this.reached_limit()?!1:(this.nodeSet[t.id]=t,this.nodes.push(t),!0)},Graph.prototype.getNode=function(t){return this.nodeSet[t]},Graph.prototype.addEdge=function(t){return t.source.addConnectedTo(t.target)===!0?(this.edgeSet[t.source.id+t.target.id]=t,this.edges.push(t),!0):!1},Graph.prototype.getEdge=function(t,e){return this.edgeSet[t+e]},Graph.prototype.reached_limit=function(){return void 0!=this.options.limit?this.options.limit<=this.nodes.length:!1},Node.prototype.addConnectedTo=function(t){return this.connectedTo(t)===!1?(this.nodesTo.push(t),!0):!1},Node.prototype.connectedTo=function(t){for(var e=0;e<this.nodesTo.length;e++){var o=this.nodesTo[e];if(o.id==t.id)return!0}return!1};var Layout=Layout||{};Layout.ForceDirected=function(t,e){var e=e||{};this.layout=e.layout||"2d",this.attraction_multiplier=e.attraction||5,this.repulsion_multiplier=e.repulsion||.75,this.max_iterations=e.iterations||1e3,this.graph=t,this.width=e.width||200,this.height=e.height||200,this.finished=!1;var o,i,s,a,n,r=e.positionUpdated,h=1e-6,l=0,c=0,d=0;this.init=function(){this.finished=!1,c=this.width/10,a=this.graph.nodes.length,n=this.graph.edges.length,s=Math.sqrt(this.height*this.width/a),o=this.attraction_multiplier*s,i=this.repulsion_multiplier*s,l=0},this.generate=function(){if(!(l<this.max_iterations&&c>1e-6))return this.finished||console.log("Average time: "+d/l+" ms"),this.finished=!0,!1;for(var e=(new Date).getTime(),s=0;a>s;s++){var u=t.nodes[s];u.layout=u.layout||{},0==s&&(u.layout.offset_x=0,u.layout.offset_y=0,"3d"===this.layout&&(u.layout.offset_z=0)),u.layout.force=0,u.layout.tmp_pos_x=u.layout.tmp_pos_x||u.position.x,u.layout.tmp_pos_y=u.layout.tmp_pos_y||u.position.y,"3d"===this.layout&&(u.layout.tmp_pos_z=u.layout.tmp_pos_z||u.position.z);for(var p=s+1;a>p;p++){var _=t.nodes[p];if(s!=p){_.layout=_.layout||{},_.layout.tmp_pos_x=_.layout.tmp_pos_x||_.position.x,_.layout.tmp_pos_y=_.layout.tmp_pos_y||_.position.y,"3d"===this.layout&&(_.layout.tmp_pos_z=_.layout.tmp_pos_z||_.position.z);var y=u.layout.tmp_pos_x-_.layout.tmp_pos_x,f=u.layout.tmp_pos_y-_.layout.tmp_pos_y;if("3d"===this.layout)var m=u.layout.tmp_pos_z-_.layout.tmp_pos_z;var g=0;g="3d"===this.layout?Math.max(h,Math.sqrt(y*y+f*f+m*m)):Math.max(h,Math.sqrt(y*y+f*f));var E=i*i/(g*g);u.layout.force+=E,_.layout.force+=E;var z=y/g*E,w=f/g*E;if(u.layout.offset_x+=z,u.layout.offset_y+=w,0==s&&(_.layout.offset_x=0,_.layout.offset_y=0,"3d"===this.layout&&(_.layout.offset_z=0)),_.layout.offset_x-=z,_.layout.offset_y-=w,"3d"===this.layout){var T=m/g*E;u.layout.offset_z+=T,_.layout.offset_z-=T}}}}for(var s=0;n>s;s++){var x=t.edges[s],y=x.source.layout.tmp_pos_x-x.target.layout.tmp_pos_x,f=x.source.layout.tmp_pos_y-x.target.layout.tmp_pos_y;if("3d"===this.layout)var m=x.source.layout.tmp_pos_z-x.target.layout.tmp_pos_z;var g=0;g="3d"===this.layout?Math.max(h,Math.sqrt(y*y+f*f+m*m)):Math.max(h,Math.sqrt(y*y+f*f));var E=g*g/o;x.source.layout.force-=E,x.target.layout.force+=E,x.source.layout.offset_x-=y/g*E,x.source.layout.offset_y-=f/g*E,"3d"===this.layout&&(x.source.layout.offset_z-=m/g*E),x.target.layout.offset_x+=y/g*E,x.target.layout.offset_y+=f/g*E,"3d"===this.layout&&(x.target.layout.offset_z+=m/g*E)}for(var s=0;a>s;s++){var v=t.nodes[s],g=0;g="3d"===this.layout?Math.max(h,Math.sqrt(v.layout.offset_x*v.layout.offset_x+v.layout.offset_y*v.layout.offset_y+v.layout.offset_z*v.layout.offset_z)):Math.max(h,Math.sqrt(v.layout.offset_x*v.layout.offset_x+v.layout.offset_y*v.layout.offset_y)),v.layout.tmp_pos_x+=v.layout.offset_x/g*Math.min(g,c),v.layout.tmp_pos_y+=v.layout.offset_y/g*Math.min(g,c),"3d"===this.layout&&(v.layout.tmp_pos_z+=v.layout.offset_z/g*Math.min(g,c));var M=!0;v.position.x-=(v.position.x-v.layout.tmp_pos_x)/10,v.position.y-=(v.position.y-v.layout.tmp_pos_y)/10,"3d"===this.layout&&(v.position.z-=(v.position.z-v.layout.tmp_pos_z)/10),M&&"function"==typeof r&&r(v)}c*=1-l/this.max_iterations,l++;var R=(new Date).getTime();return d+=R-e,!0},this.stop_calculating=function(){l=this.max_iterations}};